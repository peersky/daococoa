export const meta = {
  author: "Tim Pechersky",
  date: "28 Mar 2023",
  title: "Как устроен крипто кошелёк",
  description: "Что надо знать каждому кто пользуется цифровыми деньгами",
  tags: ["russian", "accounts", "guides"],
  path: "how-wallets-made-ru",
};

# Как устроен крипто-кошелёк

Под кошельком обычно подразумевают программу выполняющая функции кошелька.

Хотя формально говоря кошелёк это даже не какая-то конкретная программа которую вы запускаете на компьютере. Это ваши **криптографические производные** - адреса и ключи к ним. Но для простоты восприятия будем под кошельком подразумевать всё в сборе - программу и производные.

**Очень важно понять - конкретную программу кошелька всегда можно поменять, она по сути своей второстепенна и вообще не является строго необходимой.** Все операции которые только можно придумать можно выполнить и без, но это уже скорее уровень разработчиков.

Криптографические производные, матан - вот что важно!

## Немного терминологии Эфира

В виртуальной машине Эфириума (EVM) существуют _адреса_. Они же “_Счёта_” , что в переводе на английский - **_Account_.**

**Это всегда 20 байтное число (40 символов c префиксом 0х ) олицетворяющее собой “номер счёта”.**

_Address = Account = Счёт._

На _Адрес_ можно отправить активы, на нём же может быть размещён код контракта. И к каждому, в теории существует ключ доступа. Это по сути как номер банковского счёта. Только круче!

Адресов в Эфире много. Очень много: 2<sup>160</sup> → ~ 1.46<sup>48</sup> Для сравнения - в обозримой вселенной, согласно [ESA](https://www.esa.int/Science_Exploration/Space_Science/Herschel/How_many_stars_are_there_in_the_Universe) всего около 10<sup>24</sup> звёзд.

Если к конкретному адресу был подобран (сгенерирован) ключ доступа, то такой адрес принято называть **EOA (Externally owned account).**

Если в результате операции подписанной с какого-либо **EOA** на каком-то другом (псевдо) случайном адресе был размещен программный код, то такой аккаунт называют **Smart Contract,** что подчеркивает что этот счёт исполняет какую-либо логику при взаимодействии с ним.

## Какие существуют криптографические примитивы:

1. **Мнемоника**, либо как ещё её называют “**seed phrase**” либо “**wallet recovery code**”, “**backup code**” - это **самый самый тайный объект**. В популярных кошельках обычно состоит из 12 либо 24х случайно выбранных при генерации кошелька слов.
2. **Личный** **Ключ**, “**Private key**” - 32 байтное число ( 64 символа ) олицетворяющее доступ к конкретому адресу.
3. **Адрес, либо Счет - “Account”, “Address”, “EOA” -** 20 байтное число (40 символов c префиксом `0х` ) олицетворяющее собой ваш “номер вашего счёта”
4. **Публичный ключ** - 32 байтное число, которое менее на слуху, но это примитив который может быть использован для отправки вам зашифрованного сообщения
5. **Пароль -** в каждой программе могут быть разные требования к нему, его вы вводите что-бы разблокировать программу. Паролем шифруются личные ключи на диске в хранилище программного кошелька.

### Какова взаимосвязь криптографических примитивов кошелька?

Из комбинации **мнемоники** по порядку рассчитываются **личные ключи** всех счетов вплоть до нужного пользователю порядкового номера.

_У каждого счёта в кошельке есть свой порядковый номер, но это не суть важно_

Из личного ключа рассчитываются **публичный ключ,** а из него - **адрес** конкретного счёта.

В детали расчётов вдаваться здесь не буду, для гиков детали описаны в журналах по криптографии, ссылки вы найдете в [ethereum whitepaper](https://ethereum.org/669c9e2e2027310b6b3cdce6e1c52962/Ethereum_Whitepaper_-_Buterin_2014.pdf)

## Какова важность этих примитивов для безопасности ваших активов?

**Мнемоника** - Самый главный секрет. Вам достаточно знать только его для того что бы всегда восстановить остальные примитивы. На практике это значит что **её не в коем случае нельзя терять, и не в коем случае нельзя скомпрометировать**.

Если мнемоника была скомпрометирована - единственное правильное решение это срочно выводить все имеющееся активы со всех адресов которые являются частью этого кошелька (и здесь под кошельком имеется ввиду набор адресов и ключей которые вы использовали, а не лишь конкретная программа)

_К примеру вы могли использовать одну и ту же мнемонику в двух-трех разных программах кошельков с разным количеством сгенерированых счётов. Вывести надо со всех этих счетов._

Так же необходимо изолировать либо перенаправить все контракты использующие счета этой мнемоники. (далее по тексту я буду подразумевать это включенным в понятие “активы”).

**Личный ключ** - Это второй по важности секрет. Если его скомпрометировали то один конкретно связанный с ним **счёт** более не безопасен, необходимо вывести активы на другой адрес. Остальные счета всё так же в безопасности.

**Адрес и Публичный ключ** - Это по своей идеи публичная информация не несёт в себе прямой опасности кроме того дополнительной информации для хакера о том какими счетами вы пользуетесь. В некоторых случаях вы можете хотеть скрыть информацию о том что счет является примитивом вашего кошелька, но в общем случае - не паримся.

**Пароль -** Скомпрометированный пароль означает, что зашифрованные файлы ключей могут быть раскрыты. Такие файлы обычно хранятся у вас на компьютере если вы пользуетесь программой кошельком. Если вы **уверены** что сами **файлы** зашифрованные этим паролем вы не скомпрометировали то вам достаточно сменить пароль.

Однако если есть хоть малейшая вероятность что у хакера была возможность залезть к вам в систему то стоит немедленно заменить мнемонику и все счета и перевести на новые счета все активы. **Это стоит сделать если файловая система была скомпрометирована даже если пароль не был раскрыт поскольку пароль могут пытаться подобрать перебором.**

# О чем ещё стоит знать?

## **Виды кошельков**

- **Централизованный** (**custodial**) - По сути не является криптографическим кошельком в полном смысле этого слова, используя его вы полагаетесь на поставщика данного кошелька как на надежного посредника хранящего ваши активы. К примеру таковым является биржевой счёт binance либо coinbase. В вашем кабинете он вам даст адрес для перевода на счёт, но вот личных ключей - _“увольте, нет”_
- **Программа** (**non-custodial** либо **self-custodial**) - Вот это уже серьезная штука. Вы храните свои секреты сами и только вы в контроле своих средств. Может иметь разный вид - расширение для браузера, приложение для мобильного телефона либо командная строка для терминала.
- **Аппаратный кошелёк** - хранит криптографические примитивы внутри специального устройства по типу флешки. Крайне надежно, но стоит вам потерять или сломать это устройство и можно считать что активы на нём отныне и впредь - музейный экспонат. Non-custodial по своей сути.

Custodial решения я далее в принципе не рассматриваю. С ними всё ясно - вы не владеете своими активами в полной мере моего понимания с самого начала.

В случае с **self-custodial** “С великой силой приходит и великая ответственность”.

## RPC endpoint

Когда вы жмете кнопку “Отправить” ваш кошелёк соединяется через обыкновенный HTTPS протокол с каким-то сервером по ссылке которую можно найти в настройках вашего кошелька под ключевым словом “RPC URL” в настройках каждой конкретной сети с которой вы работаете.

Результат такой архитектуры в том что “**По IP вычислить**” вас таки могут. Но не все, а лишь те, кому доступна аналитика с RPC сервера который вас обслуживает ([Big brother is watching you](<https://en.wikipedia.org/wiki/Big_Brother_(Nineteen_Eighty-Four)>)).

## Кошельки-контракты

Это **Smart Contract** который выполняет функции кошелька находясь в блокчейне. Это дополнительный уровень защиты, в основном применяемый на уровне Корпоративных счетов поскольку позволяет осуществить дополнительную логику контроля над доступом. Например задержку по времени, Экстренные блокировки, Требования множественных подписей итд

Такие кошельки считаются самыми надёжными из всех возможных хотя и управляются всё теми же EOA. Сокровещницы Децентрализованых Организаций можно рассматривать как подвид такого кошелька.
